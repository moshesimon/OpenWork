generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum ConversationType {
  CHANNEL
  DM
}

model User {
  id              String         @id
  displayName     String
  avatarColor     String
  createdAt       DateTime       @default(now())
  sentMessages    Message[]      @relation("MessageSender")
  readStates      ReadState[]
  dmConversationsA Conversation[] @relation("DmUserA")
  dmConversationsB Conversation[] @relation("DmUserB")

  @@index([displayName])
}

model Channel {
  id            String         @id
  slug          String         @unique
  name          String
  createdAt     DateTime       @default(now())
  conversations Conversation[]
}

model Conversation {
  id        String           @id @default(cuid())
  type      ConversationType
  channelId String?
  dmUserAId String?
  dmUserBId String?
  createdAt DateTime         @default(now())
  channel   Channel?         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  dmUserA   User?            @relation("DmUserA", fields: [dmUserAId], references: [id], onDelete: Cascade)
  dmUserB   User?            @relation("DmUserB", fields: [dmUserBId], references: [id], onDelete: Cascade)
  messages  Message[]
  readStates ReadState[]

  @@index([type])
  @@index([dmUserAId])
  @@index([dmUserBId])
  @@index([channelId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model ReadState {
  conversationId String
  userId         String
  lastReadAt     DateTime
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@index([userId])
}
